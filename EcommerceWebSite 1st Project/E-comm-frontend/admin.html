<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>neoshop • Admin</title>
  <link rel="stylesheet" href="css/style.css"/>
</head>
<body>
  <div id="app-header"></div>
  <main class="container">
    <div class="banner"><strong>Admin Panel</strong> — Manage products, categories, users, and orders.</div>

    <!-- Tabs -->
    <div class="tabs">
      <div class="tab active" data-tab="products">Products</div>
      <div class="tab" data-tab="categories">Categories</div>
      <div class="tab" data-tab="users">Users</div>
      <div class="tab" data-tab="orders">Orders</div>
      <a class="tab" href="register.html">+ Register User</a>
    </div>

    <!-- Products Panel -->
    <section class="tabpanel active" id="tab-products">
      <div class="grid">
        <section class="main">
          <!-- Add Product -->
          <div class="card">
            <div class="body">
              <h3>Add Product</h3>
              <div class="kv"><label>Name</label><input id="pName"/></div>
              <div class="kv"><label>Details</label><input id="pDetails"/></div>
              <div class="kv"><label>Price</label><input id="pPrice" type="number" step="0.01"/></div>
              <div class="kv"><label>Quantity</label><input id="pQty" type="number"/></div>
              <div class="kv"><label>Category</label><input id="pCat"/></div>
              <div class="kv"><label>Image URL</label><input id="pImg"/></div>
              <div class="kv"><label>Active</label><input id="pActive" type="checkbox" checked/></div>
              <button id="addProductBtn" class="btn" style="margin-top:10px">Add Product</button>
            </div>
          </div>

          <!-- Update Product -->
          <div class="card" style="margin-top:16px">
            <div class="body">
              <h3>Update Product</h3>
              <div class="kv"><label>ID</label><input id="uId"/></div>
              <div class="kv"><label>Name</label><input id="uName"/></div>
              <div class="kv"><label>Details</label><input id="uDetails"/></div>
              <div class="kv"><label>Price</label><input id="uPrice" type="number"/></div>
              <div class="kv"><label>Quantity</label><input id="uQty" type="number"/></div>
              <div class="kv"><label>Category</label><input id="uCat"/></div>
              <div class="kv"><label>Image URL</label><input id="uImg"/></div>
              <div class="kv"><label>Active</label><input id="uActive" type="checkbox"/></div>
              <button id="updateProductBtn" class="btn" style="margin-top:10px">Update Product</button>
            </div>
          </div>

          <!-- Delete Product -->
          <div class="card" style="margin-top:16px">
            <div class="body">
              <h3>Delete Product</h3>
              <div class="kv"><label>Code</label><input id="dCode"/></div>
              <button id="deleteProductBtn" class="btn danger" style="margin-top:10px">Delete</button>
            </div>
          </div>

          <!-- Product List -->
          <div class="card" style="margin-top:16px">
            <div class="body">
              <div style="display:flex;align-items:center;gap:10px">
                <h3 style="margin:0">All Products</h3>
                <button id="loadProductsBtn" class="btn">Reload</button>
              </div>
              <div id="productsTableWrap" style="margin-top:12px;overflow-x:auto"></div>
            </div>
          </div>
        </section>
      </div>
    </section>

    <!-- Categories Panel -->
        <!-- Categories Panel -->
    <section class="tabpanel" id="tab-categories">
      <div class="card body">
        <div style="display:flex;align-items:center;gap:10px">
          <h3 style="margin:0">All Categories</h3>
          <button id="loadCatsBtn" class="btn">Reload</button>
          <button id="showAddCatFormBtn" class="btn">+ Add Category</button>
        </div>
        <div id="categoriesWrap" style="margin-top:12px;overflow-x:auto"></div>
      </div>

      <!-- Add / Update Category Form -->
      <div class="card body" id="catFormWrap" style="display:none;margin-top:16px">
        <h3 id="catFormTitle">Add Category</h3>
        <div class="kv"><label>ID (for update only)</label><input id="cId"/></div>
        <div class="kv"><label>Name</label><input id="cName"/></div>
        <div class="kv"><label>Description</label><input id="cDesc"/></div>
        <button id="saveCatBtn" class="btn" style="margin-top:10px">Save</button>
        <button id="cancelCatBtn" class="btn danger" style="margin-top:10px">Cancel</button>
      </div>
    </section>


    <!-- Users Panel -->
    <section class="tabpanel" id="tab-users">
      <div class="card body">
        <div style="display:flex;align-items:center;gap:10px">
          <h3 style="margin:0">Users</h3>
          <a class="btn" href="register.html">+ New User</a>
        </div>
        <div id="usersWrap" style="margin-top:12px;overflow-x:auto"></div>
      </div>
    </section>

    <!-- Orders Panel -->
    <section class="tabpanel" id="tab-orders">
      <div class="card body">
        <h3>All Orders</h3>
        <div id="ordersWrap" class="small">Loading…</div>
      </div>
    </section>
  </main>
  <div id="app-footer"></div>

  <div id="toast" class="toast" style="display:none"></div>

  <script type="module">
    import { mountHeader, mountFooter } from './js/layout.js';
    import { apiGet, apiSend, getProductImage, money } from './js/api.js';

    function toast(msg,type=''){ 
      const t=document.getElementById('toast');
      t.className='toast '+(type||'');
      t.textContent=msg; t.style.display='block';
      setTimeout(()=>t.style.display='none',2000);
    }

    // Tabs
    document.querySelectorAll('.tab').forEach(tab=>{
      if(tab.dataset.tab){
        tab.addEventListener('click',()=>{
          document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
          document.querySelectorAll('.tabpanel').forEach(p=>p.classList.remove('active'));
          tab.classList.add('active');
          document.getElementById('tab-'+tab.dataset.tab).classList.add('active');
          if(tab.dataset.tab === 'orders'){ loadOrders(); }
        });
      }
    });

    // --- Orders ---
   async function loadOrders(){
  const wrap=document.getElementById('ordersWrap');
  wrap.innerHTML='<div class="small">Loading…</div>';
  try{
    const orders=await apiGet('/api/orders');
    if(!orders.length){ wrap.innerHTML='<div class="empty">No orders.</div>';return;}
    let html=`<table class="table"><thead><tr>
      <th>ID</th><th>User</th><th>Status</th><th>Total</th><th>Items</th><th>Action</th>
    </tr></thead><tbody>`;
    for(const o of orders){
      const id=o.id??o.orderId;
      const uid=o.userId??o.user?.id;
      const status = o.orderStatus || o.status || 'PENDING';
      const total=money(o.total??o.amount??0);
      const items=(o.orderItems||o.items||[]).map(i=>{
        const name=i.product?.productName||i.productName||'Item';
        const qty=i.quantity??i.productQuantity??1;
        return `${name}×${qty}`;
      }).join(', ');
      html+=`<tr data-id="${id}">
        <td>${id}</td>
        <td>${uid}</td>
        <td>${status}</td>
        <td>${total}</td>
        <td>${items||'—'}</td>
        <td>
          <select class="statusSel">
            <option ${status==='PENDING'?'selected':''}>PENDING</option>
            <option ${status==='SHIPPED'?'selected':''}>SHIPPED</option>
            <option ${status==='DELIVERED'?'selected':''}>DELIVERED</option>
          </select>
          <button class="btn small save">Update</button>
          <button class="btn danger small remove">Remove</button> <!-- ✅ New button -->
        </td>
      </tr>`;
    }
    html+=`</tbody></table>`;
    wrap.innerHTML=html;

    // Update order status
    wrap.querySelectorAll('.save').forEach(btn=>{
      btn.addEventListener('click',async e=>{
        const tr=e.target.closest('tr');
        const id=tr.dataset.id;
        const status=tr.querySelector('.statusSel').value;
        try{
          await apiSend('PUT',`/api/orders/${id}/status?status=${status}`);
          toast('Order updated','success');
          loadOrders();
        }catch(err){ toast('Failed: '+err.message,'error'); }
      });
    });

    // ✅ Remove order
    wrap.querySelectorAll('.remove').forEach(btn=>{
      btn.addEventListener('click',async e=>{
        const tr=e.target.closest('tr');
        const id=tr.dataset.id;
        if(!confirm('Are you sure you want to delete this order?')) return;
        try{
          await apiSend('DELETE', `/api/orders/${id}`);
          toast('Order removed','success');
          loadOrders();
        }catch(err){ toast('Delete failed: '+err.message,'error'); }
      });
    });

  }catch(err){ wrap.innerHTML='<div class="empty">Failed: '+err.message+'</div>'; }
}


    // --- Products ---
    document.getElementById('addProductBtn').addEventListener('click', async ()=>{
  const body={ 
    productName: document.getElementById('pName').value.trim(),
    productDetails: document.getElementById('pDetails').value.trim(),
    productPrice: Number(document.getElementById('pPrice').value||0),
    productQuantity: Number(document.getElementById('pQty').value||0),
    isActive: document.getElementById('pActive').checked,
    category:{name: document.getElementById('pCat').value.trim()},
    imageUrl: document.getElementById('pImg').value.trim()
  };
  try{
    await apiSend('POST','/api/product/addProduct',body);
    toast('Product added','success');
    loadProducts();

    // ✅ Clear the form after success
    document.getElementById('pName').value = '';
    document.getElementById('pDetails').value = '';
    document.getElementById('pPrice').value = '';
    document.getElementById('pQty').value = '';
    document.getElementById('pCat').value = '';
    document.getElementById('pImg').value = '';
    document.getElementById('pActive').checked = true;

  }catch(err){ 
    toast('Add failed: '+err.message,'error'); 
  }
});


    // document.getElementById('addProductBtn').addEventListener('click', async ()=>{
    //   const body={ 
    //     productName: document.getElementById('pName').value.trim(),
    //     productDetails: document.getElementById('pDetails').value.trim(),
    //     productPrice: Number(document.getElementById('pPrice').value||0),
    //     productQuantity: Number(document.getElementById('pQty').value||0),
    //     isActive: document.getElementById('pActive').checked,
    //     category:{name: document.getElementById('pCat').value.trim()},
    //     imageUrl: document.getElementById('pImg').value.trim()
    //   };
    //   try{
    //     await apiSend('POST','/api/product/addProduct',body);
    //     toast('Product added','success');
    //     loadProducts();
    //   }catch(err){ toast('Add failed: '+err.message,'error'); }
    // });
document.getElementById('updateProductBtn').addEventListener('click', async ()=>{
  const id=document.getElementById('uId').value.trim();
  const body={
    productName: document.getElementById('uName').value.trim(),
    productDetails: document.getElementById('uDetails').value.trim(),
    productPrice: Number(document.getElementById('uPrice').value||0),
    productQuantity: Number(document.getElementById('uQty').value||0),
    isActive: document.getElementById('uActive').checked,
    category:{name: document.getElementById('uCat').value.trim()},
    imageUrl: document.getElementById('uImg').value.trim()
  };
  try{
    await apiSend('PUT',`/api/product/updateProduct/${encodeURIComponent(id)}`,body);
    toast('Product updated','success');
    loadProducts();

    // ✅ Clear update form after success
    document.getElementById('uId').value = '';
    document.getElementById('uName').value = '';
    document.getElementById('uDetails').value = '';
    document.getElementById('uPrice').value = '';
    document.getElementById('uQty').value = '';
    document.getElementById('uCat').value = '';
    document.getElementById('uImg').value = '';
    document.getElementById('uActive').checked = false;

  }catch(err){ 
    toast('Update failed: '+err.message,'error'); 
  }
});

    // document.getElementById('updateProductBtn').addEventListener('click', async ()=>{
    //   const id=document.getElementById('uId').value.trim();
    //   const body={
    //     productName: document.getElementById('uName').value.trim(),
    //     productDetails: document.getElementById('uDetails').value.trim(),
    //     productPrice: Number(document.getElementById('uPrice').value||0),
    //     productQuantity: Number(document.getElementById('uQty').value||0),
    //     isActive: document.getElementById('uActive').checked,
    //     category:{name: document.getElementById('uCat').value.trim()},
    //     imageUrl: document.getElementById('uImg').value.trim()
    //   };
    //   try{
    //     await apiSend('PUT',`/api/product/updateProduct/${encodeURIComponent(id)}`,body);
    //     toast('Product updated','success');
    //     loadProducts();
    //   }catch(err){ toast('Update failed: '+err.message,'error'); }
    // });

    async function deleteProductByCode(code){
      return await apiSend('DELETE', `/api/product/${encodeURIComponent(code)}`);
    }

    document.getElementById('deleteProductBtn').addEventListener('click', async ()=>{
      const code=document.getElementById('dCode').value.trim();
      if(!code){ toast('Enter a product code','error'); return; }
      try{ 
        await deleteProductByCode(code);
        toast('Product deleted','success');
        loadProducts();
      }catch(err){ toast('Delete failed: '+err.message,'error'); }
    });

    async function loadProducts(){
      const wrap=document.getElementById('productsTableWrap');
      wrap.innerHTML='<div class="small">Loading…</div>';
      try{
        const products=await apiGet('/api/product/allProduct');
        if(!products.length){ wrap.innerHTML='<div class="empty">No products.</div>';return;}
        let html=`<table class="table"><thead><tr>
        <th>ID</th><th>Code</th><th>Name</th><th>Details</th>
        <th>Price</th><th>Qty</th><th>Category</th><th>Active</th><th>Image</th><th></th>
        </tr></thead><tbody>`;
        for(const p of products){
          const id=p.id??p.productId??'—';
          const code=p.productCode??p.code??'—';
          const isActive = p.isActive ? "Yes" : "No";
          const img = getProductImage(p);
          html+=`<tr data-code="${code}" data-active="${p.isActive}">
            <td>${id}</td>
            <td>${code}</td>
            <td>${p.productName}</td>
            <td>${p.productDetails||'—'}</td>
            <td>${money(p.productPrice||0)}</td>
            <td>${p.productQuantity}</td>
            <td>${p.category?.name||p.category||'—'}</td>
            <td>${isActive}</td>
            <td><img src="${img}" alt="product" style="max-width:60px;max-height:60px"/></td>
            <td>
              <button class="btn small edit">Edit</button> 
              <button class="btn danger small del">Delete</button>
            </td>
          </tr>`;
        }
        html+=`</tbody></table>`;
        wrap.innerHTML=html;

        wrap.querySelectorAll('.edit').forEach(btn => {
  btn.addEventListener('click', e => {
    const tr = e.target.closest('tr');
    document.getElementById('uId').value = tr.children[0].textContent;
    document.getElementById('uName').value = tr.children[2].textContent;
    document.getElementById('uDetails').value = tr.children[3].textContent;
    document.getElementById('uPrice').value = tr.children[4].textContent.replace(/[^0-9.]/g, '');
    document.getElementById('uQty').value = tr.children[5].textContent;
    document.getElementById('uCat').value = tr.children[6].textContent;
    document.getElementById('uActive').checked = tr.dataset.active === "true";
    document.getElementById('uImg').value = tr.querySelector("img").getAttribute("src");

    // ✅ Scroll smoothly to update product form
    document.getElementById('updateProductBtn').closest('.card').scrollIntoView({
      behavior: 'smooth',
      block: 'start'
    });

    toast('Loaded into update form');
  });
});


        wrap.querySelectorAll('.del').forEach(btn=>{
          btn.addEventListener('click',async e=>{
            const code=e.target.closest('tr').dataset.code;
            try{ 
              await deleteProductByCode(code); 
              toast('Deleted','success'); 
              loadProducts();
            }catch(err){ toast('Delete failed: '+err.message,'error'); }
          });
        });
      }catch(err){ wrap.innerHTML='<div class="empty">Failed: '+err.message+'</div>'; }
    }

    // --- Categories ---
        // --- Categories ---
    async function loadCats(){
      const wrap=document.getElementById('categoriesWrap');
      wrap.innerHTML='<div class="small">Loading…</div>';
      try{
        const cats=await apiGet('/api/category/allCategory');
        if(!cats.length){ wrap.innerHTML='<div class="empty">No categories.</div>';return;}
        let html=`<table class="table"><thead><tr>
          <th>ID</th><th>Name</th><th>Description</th><th></th>
        </tr></thead><tbody>`;
        for(const c of cats){
          html+=`<tr data-id="${c.id}">
            <td>${c.id}</td>
            <td>${c.name}</td>
            <td>${c.description||'—'}</td>
            <td>
              <button class="btn small edit">Edit</button>
              <button class="btn danger small del">Delete</button>
            </td>
          </tr>`;
        }
        html+=`</tbody></table>`;
        wrap.innerHTML=html;

        // Edit handlers
        wrap.querySelectorAll('.edit').forEach(btn=>{
          btn.addEventListener('click',e=>{
            const tr=e.target.closest('tr');
            document.getElementById('cId').value=tr.children[0].textContent;
            document.getElementById('cName').value=tr.children[1].textContent;
            document.getElementById('cDesc').value=tr.children[2].textContent;
            document.getElementById('catFormTitle').textContent='Update Category';
            document.getElementById('catFormWrap').style.display='block';
          });
        });

        // Delete handlers
        wrap.querySelectorAll('.del').forEach(btn=>{
          btn.addEventListener('click',async e=>{
            const id=e.target.closest('tr').dataset.id;
            if(!confirm('Delete this category?')) return;
            try{
              await apiSend('DELETE',`/api/category/deleteCategory/${id}`);
              toast('Category deleted','success');
              loadCats();
            }catch(err){ toast('Delete failed: '+err.message,'error'); }
          });
        });

      }catch(err){
        wrap.innerHTML='<div class="empty">Failed: '+err.message+'</div>';
      }
    }

    // Add Category button
    document.getElementById('showAddCatFormBtn').addEventListener('click',()=>{
      document.getElementById('cId').value='';
      document.getElementById('cName').value='';
      document.getElementById('cDesc').value='';
      document.getElementById('catFormTitle').textContent='Add Category';
      document.getElementById('catFormWrap').style.display='block';
    });

    // Cancel button
    document.getElementById('cancelCatBtn').addEventListener('click',()=>{
      document.getElementById('catFormWrap').style.display='none';
    });

    // Save Category (Add or Update)
    document.getElementById('saveCatBtn').addEventListener('click',async ()=>{
      const id=document.getElementById('cId').value.trim();
      const body={
        name:document.getElementById('cName').value.trim(),
        description:document.getElementById('cDesc').value.trim()
      };
      try{
        if(id){
          await apiSend('PUT',`/api/category/updateCategory/${id}`,body);
          toast('Category updated','success');
        }else{
          await apiSend('POST','/api/category/addCategory',body);
          toast('Category added','success');
        }
        document.getElementById('catFormWrap').style.display='none';
        loadCats();
      }catch(err){ toast('Save failed: '+err.message,'error'); }
    });

    // Reload button
    document.getElementById('loadCatsBtn').addEventListener('click',loadCats);


    // --- Users ---
    async function loadUsers(){
      const wrap=document.getElementById('usersWrap');
      wrap.innerHTML='<div class="small">Loading…</div>';
      try{
        const res=await apiGet('/api/user/allUsers');
        const users=Array.isArray(res)?res:[];
        if(!users.length){ wrap.innerHTML='<div class="empty">No users.</div>';return;}
        let html=`<table class="table"><thead><tr><th>ID</th><th>Name</th><th>Email</th><th>Password</th><th></th></tr></thead><tbody>`;
        for(const u of users){
          const id=u.id??u.userId??'—';
          const name=u.username||'—';
          const email=u.userEmail||'—';
          const pass=u.userPhone||'—';
          html+=`<tr data-id="${id}">
            <td>${id}</td>
            <td contenteditable="true">${name}</td>
            <td contenteditable="true">${email}</td>
            <td contenteditable="true">${pass}</td>
            <td>
              <button class="btn small save">Update</button>
              <button class="btn danger small del">Delete</button>
              <button class="btn small set">Set Active</button>
            </td>
          </tr>`;
        }
        html+=`</tbody></table>`;
        wrap.innerHTML=html;
        wrap.querySelectorAll('.save').forEach(btn=>{
          btn.addEventListener('click',async e=>{
            const tr=e.target.closest('tr');
            const id=tr.dataset.id;
            const body={
              username: tr.children[1].textContent.trim(),
              userEmail: tr.children[2].textContent.trim(),
              userPhone: tr.children[3].textContent.trim()
            };
            try{
              await apiSend('PUT',`/api/user/${id}`,body);
              toast('User updated','success');
            }catch(err){ toast('Update failed: '+err.message,'error'); }
          });
        });
        wrap.querySelectorAll('.del').forEach(btn=>{
          btn.addEventListener('click',async e=>{
            const tr=e.target.closest('tr');
            const id=tr.dataset.id;
            if(!confirm('Delete this user?')) return;
            try{
              await apiSend('DELETE',`/api/user/${id}`);
              toast('User deleted','success');
              loadUsers();
            }catch(err){ toast('Delete failed: '+err.message,'error'); }
          });
        });
        wrap.querySelectorAll('.set').forEach(btn=>{
          btn.addEventListener('click',e=>{
            const id=e.target.closest('tr').dataset.id;
            localStorage.setItem('userId',id);
            toast('Active user set to '+id,'success');
          });
        });
      }catch(err){ wrap.innerHTML='<div class="empty">Failed: '+err.message+'</div>'; }
    }

    // Init
    mountHeader('admin'); 
    mountFooter();
    loadProducts(); 
    loadCats(); 
    loadUsers();
    loadOrders();
  </script>
</body>
</html>
